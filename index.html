<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Esc치ner Web de Mazda Carmen</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

  <h1>Esc치ner Web de Mazda Carmen</h1>

  <video id="video" autoplay playsinline></video><br>

  <label>
    <input type="checkbox" id="filtroCheckbox" checked>
    Aplicar filtro esc치ner (blanco y negro)
  </label><br>

  <button onclick="capturar()">游닞 Escanear</button>
  <button onclick="descargarPDF()">游늯 Descargar PDF</button>
  <button onclick="descargarImagen()">游뒆 Descargar Imagen</button>
  <button onclick="location.reload()">游댃 Refrescar</button><br>

  <canvas id="canvas"></canvas>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const filtroCheckbox = document.getElementById('filtroCheckbox');
    let documentoEscaneado = false;

    // Activar c치mara
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => {
        video.srcObject = stream;
      })
      .catch(error => {
        alert("No se pudo acceder a la c치mara: " + error);
      });

    // Capturar imagen con filtro esc치ner
    function capturar() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      if (filtroCheckbox.checked) {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;

        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];

          let gray = 0.3 * r + 0.59 * g + 0.11 * b;

          gray = (gray - 128) * 2 + 128;
          gray = Math.max(0, Math.min(255, gray));

          const threshold = 140;
          const value = gray > threshold ? 255 : 0;

          data[i] = data[i + 1] = data[i + 2] = value;
        }

        ctx.putImageData(imageData, 0, 0);
      }

      documentoEscaneado = true;
    }

    // Descargar como PDF
    async function descargarPDF() {
      if (!documentoEscaneado) {
        alert("No se ha escaneado ning칰n documento.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();

      const imgData = canvas.toDataURL("image/jpeg", 1.0);
      const imgWidth = 210;
      const ratio = canvas.height / canvas.width;
      const imgHeight = imgWidth * ratio;

      pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
      pdf.save("documento_escaneado.pdf");
    }

    // Descargar como imagen
    function descargarImagen() {
      if (!documentoEscaneado) {
        alert("No se ha escaneado ning칰n documento.");
        return;
      }

      const link = document.createElement('a');
      link.download = 'documento_escaneado.jpg';
      link.href = canvas.toDataURL('image/jpeg', 1.0);
      link.click();
    }
  </script>

</body>
</html>